var _=["A","B\u266D","B","C","C\u266F","D","D\u266F","E","F","F\u266F","G","G\u266F"];function k(n){return 440*2**((n-69)/12)}function T(n){return _[(n+3)%_.length]}function v(n){return n%12*360/12}var q=.05,F=.05,O=class extends EventTarget{id="synth";manufacturer="ondras";name="web audio synth";type="output";version="0.0.1";state="connected";connection="open";onstatechange=null;ctx=new AudioContext;playing=new Map;output;async open(){return this}async close(){return this}constructor(){super();let{ctx:t}=this,e=t.createDynamicsCompressor();e.connect(t.destination),this.output=e}send(t,e){let[r,o,s]=t;switch(r&240){case 144:s?this.noteOn(o):this.noteOff(o);break;case 128:this.noteOff(o);break}}noteOn(t){let{playing:e,ctx:r,output:o}=this;if(e.has(t))return;let s=W(r,k(t));s.gain.connect(o),e.set(t,s)}noteOff(t){let{playing:e}=this,r=e.get(t);r&&(X(r),e.delete(t))}};function W(n,t){let e=n.createOscillator(),r=n.createGain();return r.gain.setValueAtTime(0,n.currentTime),r.gain.linearRampToValueAtTime(1,n.currentTime+q),e.frequency.value=t,e.connect(r),e.start(),{oscillator:e,gain:r}}function X(n){let{oscillator:t,gain:e}=n,{currentTime:r}=e.context;e.gain.setValueAtTime(1,r),e.gain.linearRampToValueAtTime(0,r+F),t.stop(r+F)}function p(n){return document.createElementNS("http://www.w3.org/2000/svg",n)}var Z={center:60,edge:100,mainAxis:"vertical",invert:!1,wrap:!1},I=7;function j(n,t){let e={...Z,...t};function r(d){return e.wrap?ee(d,e.center):d}let o=e.invert?4:3,s=e.mainAxis=="vertical"?-1:1,a=document.createDocumentFragment(),c=p("g"),i=p("g");a.append(c,i);let[u,l]=n;e.mainAxis=="vertical"&&([u,l]=[l,u]);let m=Math.sqrt(3)/2*e.edge,h=Math.ceil(l/2/m),b=Math.ceil(u/2/e.edge);for(let d of H(h)){let V=Math.abs(d%2),S=e.center-d*o;S+=Math.ceil(d/2)*I;for(let N of H(b)){let f=r(S+N*I);if(f<21||f>127)continue;let w=u/2+s*e.edge*(N+V/2),C=l/2+d*m;[w,C]=[Math.round(w),Math.round(C)+.5];let $=J(f);$.style.setProperty("--hue",String(v(f))),i.append($);let L=[$];if(N<b){if(d>-h){let g=e.invert?"minor":"major",y=P(f,g,e,r);L.push(y),c.append(y)}if(d<h){let g=e.invert?"major":"minor",y=P(f,g,e,r);L.push(y),c.append(y)}}let U=Y(w,C,e.mainAxis);L.forEach(g=>g.setAttribute("transform",U))}}return a}function Y(n,t,e){switch(e){case"horizontal":return`translate(${n} ${t})`;case"vertical":return`translate(${t} ${n})`}}function J(n){let t=p("g");t.classList.add("note"),t.dataset.notes=[n].join(",");let e=p("circle"),r=p("text");return r.textContent=T(n),t.append(e,r),t}function P(n,t,e,r){let{edge:o}=e,s=Math.sqrt(3)/2*o,a=p("g");a.classList.add("chord");let c=p("path"),i=p("text"),u=T(n),l=e.invert?-1:1;switch(t){case"major":l*=1,i.textContent=u.toUpperCase(),a.dataset.notes=[n,n+4,n+7].map(r).join(",");break;case"minor":l*=-1,i.textContent=u.toLowerCase(),a.dataset.notes=[n,n+3,n+7].map(r).join(",");break}switch(e.mainAxis){case"horizontal":c.setAttribute("d",`M 0 0 h ${o} l ${-o/2} ${l*s} Z`),i.setAttribute("x",`${o/2}`),i.setAttribute("y",`${l*s/3}`);break;case"vertical":c.setAttribute("d",`M 0 0 v ${-o} l ${l*s} ${o/2} Z`),i.setAttribute("x",`${l*s/3}`),i.setAttribute("y",`${-o/2}`);break}return a.append(c,i),a}function*Q(n,t,e=1){for(let r=n;r<t;r+=e)yield r}function H(n){return Q(-n,n+1)}function ee(n,t){let e=(n-t)%12;return e<0&&(e+=12),t+e}var D=12,ne={center:60,step:1};function z(n,t){let e={...ne,...t};function r(i){return oe(i,e.center)}let o=document.createDocumentFragment(),s=Math.min(...n),a=s/2*3/4,c=s*.08;for(let i=0;i<D;i++){let u=i*Math.PI*2/D-Math.PI/2,l=n[0]/2+Math.cos(u)*a,m=n[1]/2+Math.sin(u)*a;l=Math.round(l)+.5,m=Math.round(m)+.5;let h=r(e.center+i*e.step),b=[re(h,c),R(h,"major",c,r),R(h,"minor",c,r)];b.forEach(d=>d.setAttribute("transform",`translate(${l}, ${m})`)),o.append(...b)}return o}function re(n,t){let e=p("g");e.classList.add("note"),e.dataset.notes=[n].join(","),e.style.setProperty("--hue",String(v(n)));let r=p("path");r.setAttribute("d",`M ${-t} 0 h ${2*t} a ${t} ${t} 0 1 0 ${-2*t} 0`);let o=p("text");return o.setAttribute("y",`${-t/2}`),o.textContent=T(n).toUpperCase(),e.append(r,o),e}function R(n,t,e,r){let o=p("g");o.classList.add("chord");let s=p("path"),a=p("text"),c=0,i=1;switch(t){case"major":c=-1,i=1,a.textContent="Maj",o.dataset.notes=[n,n+4,n+7].map(r).join(",");break;case"minor":c=1,i=0,a.textContent="Min",o.dataset.notes=[n,n+3,n+7].map(r).join(",");break}return s.setAttribute("d",`M 0 0 v ${e} a ${e} ${e} 0 0 ${i} ${e*c} ${-e} z`),a.setAttribute("x",`${e*c/2.5}`),a.setAttribute("y",`${e/2.5}`),o.append(s,a),o}function oe(n,t){return t+(n-t)%12}var M=class extends HTMLElement{outputs=[new O];svg=p("svg");_options;activeNotes=new Map;get shadowRoot(){return super.shadowRoot}get layout(){return this.getAttribute("layout")}get options(){return this._options}constructor(){super(),this.attachShadow({mode:"open"});let{shadowRoot:t,svg:e}=this;t.addEventListener("pointerdown",this),new ResizeObserver(()=>this.redraw()).observe(e)}redraw(){let{svg:t,offsetWidth:e,offsetHeight:r,options:o}=this,s=[e,r];switch(o.type){case"tonnetz":t.replaceChildren(j(s,o));break;case"circle":t.replaceChildren(z(s,o));break}}configure(t){this._options=t,this.setAttribute("layout",t.type),this.redraw()}async connectedCallback(){let{shadowRoot:t,svg:e}=this,r=document.createElement("link");r.rel="stylesheet",r.href=import.meta.resolve("./midi-keyboard.css"),t.replaceChildren(r,e),await se(r),this.configure({type:"circle"})}handleEvent(t){let e=t.target.closest("[data-notes]");if(e)switch(t.type){case"pointerdown":let r=new AbortController,{signal:o}=r,s=()=>{r.abort(),this.processEvent(e,"off")};e.addEventListener("pointerup",s,{signal:o}),e.addEventListener("pointerleave",s,{signal:o}),this.processEvent(e,"on"),e.parentNode.append(e);break}}processEvent(t,e){let{outputs:r,activeNotes:o}=this,s=G(t),a=0,c=[];s.forEach(i=>{let u=o.get(i)||0;if(u+=e=="on"?1:-1,u==0){o.delete(i),c.push(i);let l=[128+a,i,100];r.forEach(m=>m.send(l))}else if(o.set(i,u),u==1){c.push(i);let l=[144+a,i,100];r.forEach(m=>m.send(l))}}),c.forEach(i=>this.syncActive(i))}onMidiMessage(t){let{activeNotes:e}=this,[r,o,s]=t;switch(r&240){case 144:s?e.set(o,1):e.delete(o);break;case 128:e.delete(o);break}this.syncActive(o)}syncActive(t){let{activeNotes:e,shadowRoot:r}=this;[...r.querySelectorAll(`[data-notes*="${t}"]`)].forEach(o=>{let a=G(o).every(c=>e.has(c));o.classList.toggle("active",a)})}};customElements.define("midi-keyboard",M);function se(n){let{resolve:t,promise:e}=Promise.withResolvers();return n.addEventListener("load",t),e}function G(n){return n.dataset.notes.split(",").map(Number)}export{M as default};
