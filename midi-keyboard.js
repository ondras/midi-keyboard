var k=["A","B\u266D","B","C","C\u266F","D","D\u266F","E","F","F\u266F","G","G\u266F"];function F(r){return 440*2**((r-69)/12)}function T(r){return k[(r+3)%k.length]}function E(r){return r%12*360/12}var q=.05,_=.05,x=class extends EventTarget{id="synth";manufacturer="ondras";name="web audio synth";type="output";version="0.0.1";state="connected";connection="open";onstatechange=null;ctx=new AudioContext;playing=new Map;output;async open(){return this}async close(){return this}constructor(){super();let{ctx:n}=this,e=n.createDynamicsCompressor();e.connect(n.destination),this.output=e}send(n,e){let[t,o,i]=n;switch(t&240){case 144:i?this.noteOn(o):this.noteOff(o);break;case 128:this.noteOff(o);break}}noteOn(n){let{playing:e,ctx:t,output:o}=this;if(e.has(n))return;let i=X(t,F(n));i.gain.connect(o),e.set(n,i)}noteOff(n){let{playing:e}=this,t=e.get(n);t&&(K(t),e.delete(n))}};function X(r,n){let e=r.createOscillator(),t=r.createGain();return t.gain.setValueAtTime(0,r.currentTime),t.gain.linearRampToValueAtTime(1,r.currentTime+q),e.frequency.value=n,e.connect(t),e.start(),{oscillator:e,gain:t}}function K(r){let{oscillator:n,gain:e}=r,{currentTime:t}=e.context;e.gain.setValueAtTime(1,t),e.gain.linearRampToValueAtTime(0,t+_),n.stop(t+_)}function p(r){return document.createElementNS("http://www.w3.org/2000/svg",r)}var W={center:60,edge:100,mainAxis:"horizontal",invert:!1},I=7;function H(r,n){let e={...W,...n},t=e.invert?4:3,o=e.mainAxis=="vertical"?-1:1,i=document.createDocumentFragment(),s=p("g"),a=p("g");i.append(s,a);let[c,l]=r;e.mainAxis=="vertical"&&([c,l]=[l,c]);let u=Math.sqrt(3)/2*e.edge,d=Math.ceil(l/2/u),f=Math.ceil(c/2/e.edge);for(let m of j(d)){let N=Math.abs(m%2),b=e.center-m*t;b+=Math.ceil(m/2)*I;for(let w of j(f)){let h=b+w*I;if(h<21||h>127)continue;let C=c/2+o*e.edge*(w+N/2),$=l/2+m*u;[C,$]=[Math.round(C),Math.round($)+.5];let L=J(h);L.style.setProperty("--hue",String(E(h))),a.append(L);let S=[L];if(w<f){if(m>-d){let g=e.invert?"minor":"major",y=P(h,g,e);S.push(y),s.append(y)}if(m<d){let g=e.invert?"major":"minor",y=P(h,g,e);S.push(y),s.append(y)}}let U=Y(C,$,e.mainAxis);S.forEach(g=>g.setAttribute("transform",U))}}return i}function Y(r,n,e){switch(e){case"horizontal":return`translate(${r} ${n})`;case"vertical":return`translate(${n} ${r})`}}function J(r){let n=p("g");n.classList.add("note"),n.dataset.notes=[r].join(",");let e=p("circle"),t=p("text");return t.textContent=T(r),n.append(e,t),n}function P(r,n,e){let{edge:t}=e,o=Math.sqrt(3)/2*t,i=p("g");i.classList.add("chord");let s=p("path"),a=p("text"),c=T(r),l=e.invert?-1:1;switch(n){case"major":l*=1,a.textContent=c.toUpperCase(),i.dataset.notes=[r,r+4,r+7].join(",");break;case"minor":l*=-1,a.textContent=c.toLowerCase(),i.dataset.notes=[r,r+3,r+7].join(",");break}switch(e.mainAxis){case"horizontal":s.setAttribute("d",`M 0 0 h ${t} l ${-t/2} ${l*o} Z`),a.setAttribute("x",`${t/2}`),a.setAttribute("y",`${l*o/3}`);break;case"vertical":s.setAttribute("d",`M 0 0 v ${-t} l ${l*o} ${t/2} Z`),a.setAttribute("x",`${l*o/3}`),a.setAttribute("y",`${-t/2}`);break}return i.append(s,a),i}function*Q(r,n,e=1){for(let t=r;t<n;t+=e)yield t}function j(r){return Q(-r,r+1)}var D=12,te={center:60,step:1,radius:50};function G(r,n){let e={...te,...n},t=document.createDocumentFragment(),o=Math.min(...r),i=o/2*3/4,s=o*.08;for(let a=0;a<D;a++){let c=a*Math.PI*2/D;c-=Math.PI/2;let l=r[0]/2+Math.cos(c)*i,u=r[1]/2+Math.sin(c)*i;l=Math.round(l)+.5,u=Math.round(u)+.5;let d=e.center+a*e.step%12,f=ne(d,s);f.style.setProperty("--hue",String(E(d)));let m=R(d,"major",s),N=R(d,"minor",s);[f,m,N].forEach(b=>{b.setAttribute("transform",`translate(${l}, ${u})`),t.append(b)})}return t}function ne(r,n){let e=p("g");e.classList.add("note"),e.dataset.notes=[r].join(",");let t=p("path");t.setAttribute("d",`M ${-n} 0 h ${2*n} a ${n} ${n} 0 1 0 ${-2*n} 0`);let o=p("text");return o.setAttribute("y",`${-n/2}`),o.textContent=T(r).toUpperCase(),e.append(t,o),e}function R(r,n,e){let t=p("g");t.classList.add("chord");let o=p("path"),i=p("text"),s=0,a=1;switch(n){case"major":s=-1,a=1,i.textContent="Maj",t.dataset.notes=[r,r+4,r+7].map(z).join(",");break;case"minor":s=1,a=0,i.textContent="Min",t.dataset.notes=[r,r+3,r+7].map(z).join(",");break}return o.setAttribute("d",`M 0 0 v ${e} a ${e} ${e} 0 0 ${a} ${e*s} ${-e} z`),i.setAttribute("x",`${e*s/2.5}`),i.setAttribute("y",`${e/2.5}`),t.append(o,i),t}function z(r){return 60+(r-60)%12}var M=class extends HTMLElement{outputs=[new x];svg=p("svg");activeNotes=new Map;get shadowRoot(){return super.shadowRoot}get layout(){return this.getAttribute("layout")}constructor(){super(),this.attachShadow({mode:"open"});let{shadowRoot:n}=this;n.addEventListener("pointerdown",this)}configure(n){let{svg:e,offsetWidth:t,offsetHeight:o}=this,i=[t,o];switch(this.setAttribute("layout",n.type),n.type){case"tonnetz":e.replaceChildren(H(i,n));break;case"circle":e.replaceChildren(G(i,n));break}}async connectedCallback(){let{shadowRoot:n,svg:e}=this,t=document.createElement("link");t.rel="stylesheet",t.href=import.meta.resolve("./midi-keyboard.css"),n.replaceChildren(t,e),await oe(t),this.configure({type:"circle"})}handleEvent(n){let e=n.target.closest("[data-notes]");if(e)switch(n.type){case"pointerdown":let t=new AbortController,{signal:o}=t,i=()=>{t.abort(),this.processEvent(e,"off")};e.addEventListener("pointerup",i,{signal:o}),e.addEventListener("pointerleave",i,{signal:o}),this.processEvent(e,"on"),e.parentNode.append(e);break}}processEvent(n,e){let{outputs:t,activeNotes:o}=this,i=V(n),s=0,a=[];i.forEach(c=>{let l=o.get(c)||0;if(l+=e=="on"?1:-1,l==0){o.delete(c),a.push(c);let u=[128+s,c,100];t.forEach(d=>d.send(u))}else if(o.set(c,l),l==1){a.push(c);let u=[144+s,c,100];t.forEach(d=>d.send(u))}}),a.forEach(c=>this.syncActive(c))}onMidiMessage(n){let{activeNotes:e}=this,[t,o,i]=n;switch(t&240){case 144:i?e.set(o,1):e.delete(o);break;case 128:e.delete(o);break}this.syncActive(o)}syncActive(n){let{activeNotes:e,shadowRoot:t}=this;[...t.querySelectorAll(`[data-notes*="${n}"]`)].forEach(o=>{let s=V(o).every(a=>e.has(a));o.classList.toggle("active",s)})}};customElements.define("midi-keyboard",M);function oe(r){let{resolve:n,promise:e}=Promise.withResolvers();return r.addEventListener("load",n),e}function V(r){return r.dataset.notes.split(",").map(Number)}export{M as default};
