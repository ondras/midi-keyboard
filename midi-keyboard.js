var _=["A","B\u266D","B","C","C\u266F","D","D\u266F","E","F","F\u266F","G","G\u266F"];function k(n){return 440*2**((n-69)/12)}function T(n){return _[(n+3)%_.length]}function A(n){return n%12*360/12}async function F(){return navigator.requestMIDIAccess()}var W=.05,I=.05,v=class extends EventTarget{id="synth";manufacturer="ondras";name="web audio synth";type="output";version="0.0.1";state="connected";connection="open";onstatechange=null;ctx=new AudioContext;playing=new Map;output;async open(){return this}async close(){return this}constructor(){super();let{ctx:t}=this,e=t.createDynamicsCompressor();e.connect(t.destination),this.output=e}send(t,e){let[r,o,i]=t;switch(r&240){case 144:i?this.noteOn(o):this.noteOff(o);break;case 128:this.noteOff(o);break}}noteOn(t){let{playing:e,ctx:r,output:o}=this;if(e.has(t))return;let i=X(r,k(t));i.gain.connect(o),e.set(t,i)}noteOff(t){let{playing:e}=this,r=e.get(t);r&&(K(r),e.delete(t))}};function X(n,t){let e=n.createOscillator(),r=n.createGain();return r.gain.setValueAtTime(0,n.currentTime),r.gain.linearRampToValueAtTime(1,n.currentTime+W),e.frequency.value=t,e.connect(r),e.start(),{oscillator:e,gain:r}}function K(n){let{oscillator:t,gain:e}=n,{currentTime:r}=e.context;e.gain.setValueAtTime(1,r),e.gain.linearRampToValueAtTime(0,r+I),t.stop(r+I)}function p(n){return document.createElementNS("http://www.w3.org/2000/svg",n)}var Y={center:60,edge:100,mainAxis:"vertical",invert:!1,wrap:!1},P=7;function j(n,t){let e={...Y,...t};function r(d){return e.wrap?te(d,e.center):d}let o=e.invert?4:3,i=e.mainAxis=="vertical"?-1:1,a=document.createDocumentFragment(),c=p("g"),s=p("g");a.append(c,s);let[u,l]=n;e.mainAxis=="vertical"&&([u,l]=[l,u]);let m=Math.sqrt(3)/2*e.edge,h=Math.ceil(l/2/m),b=Math.ceil(u/2/e.edge);for(let d of H(h)){let V=Math.abs(d%2),S=e.center-d*o;S+=Math.ceil(d/2)*P;for(let N of H(b)){let f=r(S+N*P);if(f<21||f>127)continue;let w=u/2+i*e.edge*(N+V/2),C=l/2+d*m;[w,C]=[Math.round(w),Math.round(C)+.5];let $=Q(f);$.style.setProperty("--hue",String(A(f))),s.append($);let L=[$];if(N<b){if(d>-h){let g=e.invert?"minor":"major",y=D(f,g,e,r);L.push(y),c.append(y)}if(d<h){let g=e.invert?"major":"minor",y=D(f,g,e,r);L.push(y),c.append(y)}}let U=J(w,C,e.mainAxis);L.forEach(g=>g.setAttribute("transform",U))}}return a}function J(n,t,e){switch(e){case"horizontal":return`translate(${n} ${t})`;case"vertical":return`translate(${t} ${n})`}}function Q(n){let t=p("g");t.classList.add("note"),t.dataset.notes=[n].join(",");let e=p("circle"),r=p("text");return r.textContent=T(n),t.append(e,r),t}function D(n,t,e,r){let{edge:o}=e,i=Math.sqrt(3)/2*o,a=p("g");a.classList.add("chord");let c=p("path"),s=p("text"),u=T(n),l=e.invert?-1:1;switch(t){case"major":l*=1,s.textContent=u.toUpperCase(),a.dataset.notes=[n,n+4,n+7].map(r).join(",");break;case"minor":l*=-1,s.textContent=u.toLowerCase(),a.dataset.notes=[n,n+3,n+7].map(r).join(",");break}switch(e.mainAxis){case"horizontal":c.setAttribute("d",`M 0 0 h ${o} l ${-o/2} ${l*i} Z`),s.setAttribute("x",`${o/2}`),s.setAttribute("y",`${l*i/3}`);break;case"vertical":c.setAttribute("d",`M 0 0 v ${-o} l ${l*i} ${o/2} Z`),s.setAttribute("x",`${l*i/3}`),s.setAttribute("y",`${-o/2}`);break}return a.append(c,s),a}function*ee(n,t,e=1){for(let r=n;r<t;r+=e)yield r}function H(n){return ee(-n,n+1)}function te(n,t){let e=(n-t)%12;return e<0&&(e+=12),t+e}var R=12,re={center:60,step:1};function G(n,t){let e={...re,...t};function r(s){return se(s,e.center)}let o=document.createDocumentFragment(),i=Math.min(...n),a=i/2*3/4,c=i*.08;for(let s=0;s<R;s++){let u=s*Math.PI*2/R-Math.PI/2,l=n[0]/2+Math.cos(u)*a,m=n[1]/2+Math.sin(u)*a;l=Math.round(l)+.5,m=Math.round(m)+.5;let h=r(e.center+s*e.step),b=[oe(h,c),z(h,"major",c,r),z(h,"minor",c,r)];b.forEach(d=>d.setAttribute("transform",`translate(${l}, ${m})`)),o.append(...b)}return o}function oe(n,t){let e=p("g");e.classList.add("note"),e.dataset.notes=[n].join(","),e.style.setProperty("--hue",String(A(n)));let r=p("path");r.setAttribute("d",`M ${-t} 0 h ${2*t} a ${t} ${t} 0 1 0 ${-2*t} 0`);let o=p("text");return o.setAttribute("y",`${-t/2}`),o.textContent=T(n).toUpperCase(),e.append(r,o),e}function z(n,t,e,r){let o=p("g");o.classList.add("chord");let i=p("path"),a=p("text"),c=0,s=1;switch(t){case"major":c=-1,s=1,a.textContent="Maj",o.dataset.notes=[n,n+4,n+7].map(r).join(",");break;case"minor":c=1,s=0,a.textContent="Min",o.dataset.notes=[n,n+3,n+7].map(r).join(",");break}return i.setAttribute("d",`M 0 0 v ${e} a ${e} ${e} 0 0 ${s} ${e*c} ${-e} z`),a.setAttribute("x",`${e*c/2.5}`),a.setAttribute("y",`${e/2.5}`),o.append(i,a),o}function se(n,t){return t+(n-t)%12}var M=class extends HTMLElement{outputs=[new v];svg=p("svg");_options;activeNotes=new Map;get shadowRoot(){return super.shadowRoot}get layout(){return this.getAttribute("layout")}get options(){return this._options}constructor(){super(),this.attachShadow({mode:"open"});let{shadowRoot:t,svg:e}=this;t.addEventListener("pointerdown",this),new ResizeObserver(()=>this.redraw()).observe(e),F().then(o=>{let i=[...o.outputs.values()];this.outputs.push(...i)})}redraw(){let{svg:t,offsetWidth:e,offsetHeight:r,options:o}=this;if(!o)return;let i=[e,r];switch(o.type){case"tonnetz":t.replaceChildren(j(i,o));break;case"circle":t.replaceChildren(G(i,o));break}}configure(t){this._options=t,this.setAttribute("layout",t.type),this.redraw()}async connectedCallback(){let{shadowRoot:t,svg:e}=this,r=document.createElement("link");r.rel="stylesheet",r.href=import.meta.resolve("./midi-keyboard.css"),t.replaceChildren(r,e),await ae(r),this.configure({type:"circle"})}handleEvent(t){let e=t.target.closest("[data-notes]");if(e)switch(t.type){case"pointerdown":let r=new AbortController,{signal:o}=r,i=()=>{r.abort(),this.processEvent(e,"off")};e.addEventListener("pointerup",i,{signal:o}),e.addEventListener("pointerleave",i,{signal:o}),this.processEvent(e,"on"),e.parentNode.append(e);break}}processEvent(t,e){let{outputs:r,activeNotes:o}=this,i=q(t),a=0,c=[];i.forEach(s=>{let u=o.get(s)||0;if(u+=e=="on"?1:-1,u==0){o.delete(s),c.push(s);let l=[128+a,s,100];r.forEach(m=>m.send(l))}else if(o.set(s,u),u==1){c.push(s);let l=[144+a,s,100];r.forEach(m=>m.send(l))}}),c.forEach(s=>this.syncActive(s))}onMidiMessage(t){let{activeNotes:e}=this,[r,o,i]=t;switch(r&240){case 144:i?e.set(o,1):e.delete(o);break;case 128:e.delete(o);break}this.syncActive(o)}syncActive(t){let{activeNotes:e,shadowRoot:r}=this;[...r.querySelectorAll(`[data-notes*="${t}"]`)].forEach(o=>{let a=q(o).every(c=>e.has(c));o.classList.toggle("active",a)})}};customElements.define("midi-keyboard",M);function ae(n){let{resolve:t,promise:e}=Promise.withResolvers();return n.addEventListener("load",t),e}function q(n){return n.dataset.notes.split(",").map(Number)}export{M as default};
