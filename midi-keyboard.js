var S=["A","B\u266D","B","C","C\u266F","D","D\u266F","E","F","F\u266F","G","G\u266F"];function L(r){return 440*2**((r-69)/12)}function A(r){return S[(r+3)%S.length]}var H=.05,$=.05,b=class extends EventTarget{id="synth";manufacturer="ondras";name="web audio synth";type="output";version="0.0.1";state="connected";connection="open";onstatechange=null;ctx=new AudioContext;playing=new Map;output;async open(){return this}async close(){return this}constructor(){super();let{ctx:t}=this,e=t.createDynamicsCompressor();e.connect(t.destination),this.output=e}send(t,e){let[o,s,n]=t;switch(o&240){case 144:n?this.noteOn(s):this.noteOff(s);break;case 128:this.noteOff(s);break}}noteOn(t){let{playing:e,ctx:o,output:s}=this;if(e.has(t))return;let n=G(o,L(t));n.gain.connect(s),e.set(t,n)}noteOff(t){let{playing:e}=this,o=e.get(t);o&&(D(o),e.delete(t))}};function G(r,t){let e=r.createOscillator(),o=r.createGain();return o.gain.setValueAtTime(0,r.currentTime),o.gain.linearRampToValueAtTime(1,r.currentTime+H),e.frequency.value=t,e.connect(o),e.start(),{oscillator:e,gain:o}}function D(r){let{oscillator:t,gain:e}=r,{currentTime:o}=e.context;e.gain.setValueAtTime(1,o),e.gain.linearRampToValueAtTime(0,o+$),t.stop(o+$)}var P={center:60,edge:100,mainStep:7,topRightStep:3};function F(r,t){let e=p("svg"),o=p("g"),s=p("g");e.append(o,s);let n={...P,...t},[m,u]=r,i=Math.sqrt(3)/2*n.edge,c=Math.ceil(u/2/i),h=Math.ceil(m/2/n.edge);for(let l=-c;l<=c;l++){let _=Math.abs(l%2),v=n.center-l*n.topRightStep;v+=Math.ceil(l/2)*n.mainStep;for(let g=-h;g<=h;g++){let d=v+g*n.mainStep;if(d<21||d>127)continue;let f=m/2+g*n.edge+_*n.edge/2,E=u/2+l*i;[f,E]=[Math.round(f),Math.round(E)+.5];let N=p("g");N.classList.add("note"),N.setAttribute("transform",`translate(${f} ${E})`),N.dataset.notes=[d].join(",");let k=p("circle"),M=p("text");if(M.textContent=A(d),N.append(k,M),s.append(N),g<h){let w=A(d);if(l>-c){let a=C(w.toLowerCase());a.node.setAttribute("transform",`translate(${f} ${E})`),a.dataset.notes=[d,d+n.topRightStep,d+n.mainStep].join(","),a.path.setAttribute("d",`M 0 0 l ${n.edge/2} ${-i} l ${n.edge/2} ${i} Z`),a.text.setAttribute("x",`${n.edge/2}`),a.text.setAttribute("y",`${-i/3}`),o.append(a.node)}if(l<c){let a=C(w.toUpperCase());a.node.setAttribute("transform",`translate(${f} ${E})`),a.dataset.notes=[d,d+n.mainStep-n.topRightStep,d+n.mainStep].join(","),a.path.setAttribute("d",`M 0 0 l ${n.edge/2} ${i} l ${n.edge/2} ${-i} Z`),a.text.setAttribute("x",`${n.edge/2}`),a.text.setAttribute("y",`${i/3}`),o.append(a.node)}}}}return e}function C(r){let t=p("g");t.classList.add("chord");let e=p("path"),o=p("text");return o.textContent=r,t.append(e,o),{node:t,dataset:t.dataset,path:e,text:o}}function p(r){return document.createElementNS("http://www.w3.org/2000/svg",r)}var O=class extends HTMLElement{outputs=[new b];activeNotes=new Map;get shadowRoot(){return super.shadowRoot}get layout(){return this.getAttribute("layout")}constructor(){super(),this.attachShadow({mode:"open"});let{shadowRoot:t}=this;t.addEventListener("pointerdown",this)}async connectedCallback(){let{shadowRoot:t}=this,e=document.createElement("link");e.rel="stylesheet",e.href=import.meta.resolve("./midi-keyboard.css"),t.replaceChildren(e),await q(e);let o=[this.offsetWidth,this.offsetHeight],s=F(o,{});this.setAttribute("layout","tonnetz"),t.append(s)}handleEvent(t){let e=t.target.closest("[data-notes]");if(e)switch(t.type){case"pointerdown":let o=new AbortController,{signal:s}=o,n=()=>{o.abort(),this.processEvent(e,"off")};e.addEventListener("pointerup",n,{signal:s}),e.addEventListener("pointerleave",n,{signal:s}),this.processEvent(e,"on"),e.parentNode.append(e);break}}processEvent(t,e){let{outputs:o,activeNotes:s}=this,n=R(t),m=0,u=[];n.forEach(i=>{let c=s.get(i)||0;if(c+=e=="on"?1:-1,c==0){s.delete(i),u.push(i);let h=[128+m,i,100];o.forEach(l=>l.send(h))}else if(s.set(i,c),c==1){u.push(i);let h=[144+m,i,100];o.forEach(l=>l.send(h))}}),u.forEach(i=>this.syncActive(i))}onMidiMessage(t){let{activeNotes:e}=this,[o,s,n]=t;switch(o&240){case 144:n?e.set(s,1):e.delete(s);break;case 128:e.delete(s);break}this.syncActive(s)}syncActive(t){let{activeNotes:e,shadowRoot:o}=this;[...o.querySelectorAll(`[data-notes*="${t}"]`)].forEach(s=>{let m=R(s).every(u=>e.has(u));s.classList.toggle("active",m)})}};customElements.define("midi-keyboard",O);function q(r){let{resolve:t,promise:e}=Promise.withResolvers();return r.addEventListener("load",t),e}function R(r){return r.dataset.notes.split(",").map(Number)}export{O as default};
