var S=["A","B\u266D","B","C","C\u266F","D","D\u266F","E","F","F\u266F","G","G\u266F"];function k(r){return 440*2**((r-69)/12)}function y(r){return S[(r+3)%S.length]}var V=.05,F=.05,T=class extends EventTarget{id="synth";manufacturer="ondras";name="web audio synth";type="output";version="0.0.1";state="connected";connection="open";onstatechange=null;ctx=new AudioContext;playing=new Map;output;async open(){return this}async close(){return this}constructor(){super();let{ctx:n}=this,e=n.createDynamicsCompressor();e.connect(n.destination),this.output=e}send(n,e){let[t,o,a]=n;switch(t&240){case 144:a?this.noteOn(o):this.noteOff(o);break;case 128:this.noteOff(o);break}}noteOn(n){let{playing:e,ctx:t,output:o}=this;if(e.has(n))return;let a=U(t,k(n));a.gain.connect(o),e.set(n,a)}noteOff(n){let{playing:e}=this,t=e.get(n);t&&(q(t),e.delete(n))}};function U(r,n){let e=r.createOscillator(),t=r.createGain();return t.gain.setValueAtTime(0,r.currentTime),t.gain.linearRampToValueAtTime(1,r.currentTime+V),e.frequency.value=n,e.connect(t),e.start(),{oscillator:e,gain:t}}function q(r){let{oscillator:n,gain:e}=r,{currentTime:t}=e.context;e.gain.setValueAtTime(1,t),e.gain.linearRampToValueAtTime(0,t+F),n.stop(t+F)}function d(r){return document.createElementNS("http://www.w3.org/2000/svg",r)}var B={center:60,edge:100,mainAxis:"horizontal",invert:!1},_=7;function D(r,n){let e={...B,...n},t=e.invert?4:3,o=e.mainAxis=="vertical"?-1:1,a=document.createDocumentFragment(),s=d("g"),i=d("g");a.append(s,i);let[c,l]=r;e.mainAxis=="vertical"&&([c,l]=[l,c]);let m=Math.sqrt(3)/2*e.edge,p=Math.ceil(l/2/m),E=Math.ceil(c/2/e.edge);for(let u of j(p)){let M=Math.abs(u%2),h=e.center-u*t;h+=Math.ceil(u/2)*_;for(let N of j(E)){let f=h+N*_;if(f<21||f>127)continue;let w=c/2+o*e.edge*(N+M/2),C=l/2+u*m;[w,C]=[Math.round(w),Math.round(C)+.5];let L=W(f);i.append(L);let $=[L];if(N<E){if(u>-p){let b=e.invert?"minor":"major",g=I(f,b,e);$.push(g),s.append(g)}if(u<p){let b=e.invert?"major":"minor",g=I(f,b,e);$.push(g),s.append(g)}}let G=Z(w,C,e.mainAxis);$.forEach(b=>b.setAttribute("transform",G))}}return a}function Z(r,n,e){switch(e){case"horizontal":return`translate(${r} ${n})`;case"vertical":return`translate(${n} ${r})`}}function W(r){let n=d("g");n.classList.add("note"),n.dataset.notes=[r].join(",");let e=d("circle"),t=d("text");return t.textContent=y(r),n.append(e,t),n}function I(r,n,e){let{edge:t}=e,o=Math.sqrt(3)/2*t,a=d("g");a.classList.add("chord");let s=d("path"),i=d("text"),c=y(r),l=e.invert?-1:1;switch(n){case"major":l*=1,i.textContent=c.toUpperCase(),a.dataset.notes=[r,r+4,r+7].join(",");break;case"minor":l*=-1,i.textContent=c.toLowerCase(),a.dataset.notes=[r,r+3,r+7].join(",");break}switch(e.mainAxis){case"horizontal":s.setAttribute("d",`M 0 0 h ${t} l ${-t/2} ${l*o} Z`),i.setAttribute("x",`${t/2}`),i.setAttribute("y",`${l*o/3}`);break;case"vertical":s.setAttribute("d",`M 0 0 v ${-t} l ${l*o} ${t/2} Z`),i.setAttribute("x",`${l*o/3}`),i.setAttribute("y",`${-t/2}`);break}return a.append(s,i),a}function*Y(r,n,e=1){for(let t=r;t<n;t+=e)yield t}function j(r){return Y(-r,r+1)}var P=12,Q={center:60,step:1,radius:50};function z(r,n){let e={...Q,...n},t=document.createDocumentFragment(),o=Math.min(...r),a=o/2*3/4,s=o*.08;for(let i=0;i<P;i++){let c=i*Math.PI*2/P;c-=Math.PI/2;let l=r[0]/2+Math.cos(c)*a,m=r[1]/2+Math.sin(c)*a;l=Math.round(l)+.5,m=Math.round(m)+.5;let p=e.center+i*e.step%12,E=ee(p,s),u=R(p,"major",s),M=R(p,"minor",s);[E,u,M].forEach(h=>{h.setAttribute("transform",`translate(${l}, ${m})`),t.append(h)})}return t}function ee(r,n){let e=d("g");e.classList.add("note"),e.dataset.notes=[r].join(",");let t=d("path");t.setAttribute("d",`M ${-n} 0 h ${2*n} a ${n} ${n} 0 1 0 ${-2*n} 0`);let o=d("text");return o.setAttribute("y",`${-n/2}`),o.textContent=y(r).toUpperCase(),e.append(t,o),e}function R(r,n,e){let t=d("g");t.classList.add("chord");let o=d("path"),a=d("text"),s=0,i=1;switch(n){case"major":s=-1,i=1,a.textContent="Maj",t.dataset.notes=[r,r+4,r+7].join(",");break;case"minor":s=1,i=0,a.textContent="Min",t.dataset.notes=[r,r+3,r+7].join(",");break}return o.setAttribute("d",`M 0 0 v ${e} a ${e} ${e} 0 0 ${i} ${e*s} ${-e} z`),a.setAttribute("x",`${e*s/2.5}`),a.setAttribute("y",`${e/2.5}`),t.append(o,a),t}var v=class extends HTMLElement{outputs=[new T];svg=d("svg");activeNotes=new Map;get shadowRoot(){return super.shadowRoot}get layout(){return this.getAttribute("layout")}constructor(){super(),this.attachShadow({mode:"open"});let{shadowRoot:n}=this;n.addEventListener("pointerdown",this)}configure(n){let{svg:e,offsetWidth:t,offsetHeight:o}=this,a=[t,o];switch(this.setAttribute("layout",n.type),n.type){case"tonnetz":e.replaceChildren(D(a,n));break;case"circle":e.replaceChildren(z(a,n));break}}async connectedCallback(){let{shadowRoot:n,svg:e}=this,t=document.createElement("link");t.rel="stylesheet",t.href=import.meta.resolve("./midi-keyboard.css"),n.replaceChildren(t,e),await ne(t),this.configure({type:"circle"})}handleEvent(n){let e=n.target.closest("[data-notes]");if(e)switch(n.type){case"pointerdown":let t=new AbortController,{signal:o}=t,a=()=>{t.abort(),this.processEvent(e,"off")};e.addEventListener("pointerup",a,{signal:o}),e.addEventListener("pointerleave",a,{signal:o}),this.processEvent(e,"on"),e.parentNode.append(e);break}}processEvent(n,e){let{outputs:t,activeNotes:o}=this,a=H(n),s=0,i=[];a.forEach(c=>{let l=o.get(c)||0;if(l+=e=="on"?1:-1,l==0){o.delete(c),i.push(c);let m=[128+s,c,100];t.forEach(p=>p.send(m))}else if(o.set(c,l),l==1){i.push(c);let m=[144+s,c,100];t.forEach(p=>p.send(m))}}),i.forEach(c=>this.syncActive(c))}onMidiMessage(n){let{activeNotes:e}=this,[t,o,a]=n;switch(t&240){case 144:a?e.set(o,1):e.delete(o);break;case 128:e.delete(o);break}this.syncActive(o)}syncActive(n){let{activeNotes:e,shadowRoot:t}=this;[...t.querySelectorAll(`[data-notes*="${n}"]`)].forEach(o=>{let s=H(o).every(i=>e.has(i));o.classList.toggle("active",s)})}};customElements.define("midi-keyboard",v);function ne(r){let{resolve:n,promise:e}=Promise.withResolvers();return r.addEventListener("load",n),e}function H(r){return r.dataset.notes.split(",").map(Number)}export{v as default};
