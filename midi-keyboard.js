var A=["A","B\u266D","B","C","C\u266F","D","D\u266F","E","F","F\u266F","G","G\u266F"];function $(r){return 440*2**((r-69)/12)}function w(r){return A[(r+3)%A.length]}var y=class extends EventTarget{id="synth";manufacturer="ondras";name="web audio synth";type="output";version="0.0.1";state="connected";connection="open";onstatechange=null;ctx=new AudioContext;playing=new Map;async open(){return this}async close(){return this}send(t,e){let[n,s,o]=t;switch(n&240){case 144:o?this.noteOn(s):this.noteOff(s);break;case 128:this.noteOff(s);break}}noteOn(t){let{playing:e,ctx:n}=this;if(e.has(t))return;let s=n.createOscillator();s.frequency.value=$(t),s.connect(n.destination),s.start(),e.set(t,s)}noteOff(t){let{playing:e}=this,n=e.get(t);n&&(n.stop(),e.delete(t))}};var H={center:60,edge:100,mainStep:7,topRightStep:3};function F(r,t){let e=d("svg"),n=d("g"),s=d("g");e.append(n,s);let o={...H,...t},[p,u]=r,i=Math.sqrt(3)/2*o.edge,m=Math.ceil(u/2/i),x=Math.ceil(p/2/o.edge);for(let c=-m;c<=m;c++){let _=Math.abs(c%2),M=o.center-c*o.topRightStep;M+=Math.ceil(c/2)*o.mainStep;for(let h=-x;h<=x;h++){let l=M+h*o.mainStep;if(l<21||l>127)continue;let g=p/2+h*o.edge+_*o.edge/2,f=u/2+c*i;[g,f]=[Math.round(g),Math.round(f)+.5];let b=d("g");b.classList.add("note"),b.setAttribute("transform",`translate(${g} ${f})`),b.dataset.notes=[l].join(",");let k=d("circle"),v=d("text");if(v.textContent=w(l),b.append(k,v),s.append(b),h<x){let S=w(l);if(c>-m){let a=L(S.toLowerCase());a.node.setAttribute("transform",`translate(${g} ${f})`),a.dataset.notes=[l,l+o.topRightStep,l+o.mainStep].join(","),a.path.setAttribute("d",`M 0 0 l ${o.edge/2} ${-i} l ${o.edge/2} ${i} Z`),a.text.setAttribute("x",`${o.edge/2}`),a.text.setAttribute("y",`${-i/3}`),n.append(a.node)}if(c<m){let a=L(S.toUpperCase());a.node.setAttribute("transform",`translate(${g} ${f})`),a.dataset.notes=[l,l+o.mainStep-o.topRightStep,l+o.mainStep].join(","),a.path.setAttribute("d",`M 0 0 l ${o.edge/2} ${i} l ${o.edge/2} ${-i} Z`),a.text.setAttribute("x",`${o.edge/2}`),a.text.setAttribute("y",`${i/3}`),n.append(a.node)}}}}return e}function L(r){let t=d("g");t.classList.add("chord");let e=d("path"),n=d("text");return n.textContent=r,t.append(e,n),{node:t,dataset:t.dataset,path:e,text:n}}function d(r){return document.createElementNS("http://www.w3.org/2000/svg",r)}var N=class extends HTMLElement{outputs=[new y];activeNotes=new Set;get shadowRoot(){return super.shadowRoot}get layout(){return this.getAttribute("layout")}constructor(){super(),this.attachShadow({mode:"open"});let{shadowRoot:t}=this;t.addEventListener("pointerdown",this),t.addEventListener("pointerup",this)}async connectedCallback(){let{shadowRoot:t}=this,e=document.createElement("link");e.rel="stylesheet",e.href=import.meta.resolve("./midi-keyboard.css"),t.replaceChildren(e),await I(e);let n=[this.offsetWidth,this.offsetHeight],s=F(n,{});this.setAttribute("layout","tonnetz"),t.append(s)}handleEvent(t){switch(t.type){case"pointerdown":case"pointerup":let e=t.target.closest("[data-notes]");if(!e)return;this.processEvent(e,t.type);break}}processEvent(t,e){console.log(t,e);let{outputs:n}=this,s=t.dataset.notes.split(",").map(Number),p=(e=="pointerdown"?144:128)+0;s.forEach(u=>{let i=[p,u,100];n.forEach(m=>m.send(i)),this.applyMidiMessage(i)})}applyMidiMessage(t){let{activeNotes:e}=this,[n,s,o]=t;switch(n&240){case 144:o?e.add(s):e.delete(s);break;case 128:e.delete(s);break}this.syncActive(s)}syncActive(t){let{activeNotes:e,shadowRoot:n}=this;[...n.querySelectorAll(`[data-notes*="${t}"]`)].forEach(s=>{let p=s.dataset.notes.split(",").map(Number).every(u=>e.has(u));s.classList.toggle("active",p)})}};customElements.define("midi-keyboard",N);function I(r){let{resolve:t,promise:e}=Promise.withResolvers();return r.addEventListener("load",t),e}export{N as default};
