var $=["A","B\u266D","B","C","C\u266F","D","D\u266F","E","F","F\u266F","G","G\u266F"];function S(r){return 440*2**((r-69)/12)}function h(r){return $[(r+3)%$.length]}var U=.05,k=.05,T=class extends EventTarget{id="synth";manufacturer="ondras";name="web audio synth";type="output";version="0.0.1";state="connected";connection="open";onstatechange=null;ctx=new AudioContext;playing=new Map;output;async open(){return this}async close(){return this}constructor(){super();let{ctx:t}=this,e=t.createDynamicsCompressor();e.connect(t.destination),this.output=e}send(t,e){let[n,o,i]=t;switch(n&240){case 144:i?this.noteOn(o):this.noteOff(o);break;case 128:this.noteOff(o);break}}noteOn(t){let{playing:e,ctx:n,output:o}=this;if(e.has(t))return;let i=V(n,S(t));i.gain.connect(o),e.set(t,i)}noteOff(t){let{playing:e}=this,n=e.get(t);n&&(q(n),e.delete(t))}};function V(r,t){let e=r.createOscillator(),n=r.createGain();return n.gain.setValueAtTime(0,r.currentTime),n.gain.linearRampToValueAtTime(1,r.currentTime+U),e.frequency.value=t,e.connect(n),e.start(),{oscillator:e,gain:n}}function q(r){let{oscillator:t,gain:e}=r,{currentTime:n}=e.context;e.gain.setValueAtTime(1,n),e.gain.linearRampToValueAtTime(0,n+k),t.stop(n+k)}function l(r){return document.createElementNS("http://www.w3.org/2000/svg",r)}var Z={center:60,edge:100,mainAxis:"horizontal",invert:!1},F=7;function j(r,t){let e={...Z,...t},n=e.invert?4:3,o=e.mainAxis=="vertical"?-1:1,i=document.createDocumentFragment(),s=l("g"),c=l("g");i.append(s,c);let[a,d]=r;e.mainAxis=="vertical"&&([a,d]=[d,a]);let u=Math.sqrt(3)/2*e.edge,m=Math.ceil(d/2/u),g=Math.ceil(a/2/e.edge);for(let p of I(m)){let H=Math.abs(p%2),C=e.center-p*n;C+=Math.ceil(p/2)*F;for(let O of I(g)){let f=C+O*F;if(f<21||f>127)continue;let M=a/2+o*e.edge*(O+H/2),v=d/2+p*u;[M,v]=[Math.round(M),Math.round(v)+.5];let L=W(f);c.append(L);let w=[L];if(O<g){if(p>-m){let b=e.invert?"minor":"major",y=_(f,b,e);w.push(y),s.append(y)}if(p<m){let b=e.invert?"major":"minor",y=_(f,b,e);w.push(y),s.append(y)}}let G=B(M,v,e.mainAxis);w.forEach(b=>b.setAttribute("transform",G))}}return i}function B(r,t,e){switch(e){case"horizontal":return`translate(${r} ${t})`;case"vertical":return`translate(${t} ${r})`}}function W(r){let t=l("g");t.classList.add("note"),t.dataset.notes=[r].join(",");let e=l("circle"),n=l("text");return n.textContent=h(r),t.append(e,n),t}function _(r,t,e){let n=Math.sqrt(3)/2*e.edge,o=l("g");o.classList.add("chord");let i=l("path"),s=l("text"),c=h(r),a=e.invert?-1:1;switch(t){case"major":a*=1,s.textContent=c.toUpperCase(),o.dataset.notes=[r,r+4,r+7].join(",");break;case"minor":a*=-1,s.textContent=c.toLowerCase(),o.dataset.notes=[r,r+3,r+7].join(",");break}switch(e.mainAxis){case"horizontal":i.setAttribute("d",`M 0 0 h ${e.edge} l ${-e.edge/2} ${a*n} Z`),s.setAttribute("x",`${e.edge/2}`),s.setAttribute("y",`${a*n/3}`);break;case"vertical":i.setAttribute("d",`M 0 0 v ${-e.edge} l ${a*n} ${e.edge/2} Z`),s.setAttribute("x",`${a*n/3}`),s.setAttribute("y",`${-e.edge/2}`);break}return o.append(i,s),o}function*Y(r,t,e=1){for(let n=r;n<t;n+=e)yield n}function I(r){return Y(-r,r+1)}var D=12,Q={center:60,step:1,edge:60};function z(r,t){let e={...Q,...t},n=document.createDocumentFragment(),i=Math.min(...r)/2*3/4;for(let s=0;s<D;s++){let c=s*Math.PI*2/D;c-=Math.PI/2;let a=r[0]/2+Math.cos(c)*i,d=r[1]/2+Math.sin(c)*i,u=e.center+s*e.step%12,m=ee(u);m.setAttribute("transform",`translate(${a}, ${d-e.edge/2})`);let g=P(u,"major",e);g.setAttribute("transform",`translate(${a-e.edge/3}, ${d+e.edge/3})`);let p=P(u,"minor",e);p.setAttribute("transform",`translate(${a+e.edge/3}, ${d+e.edge/3})`),n.append(m,g,p)}return n}function ee(r){let t=l("g");t.classList.add("note"),t.dataset.notes=[r].join(",");let e=l("circle"),n=l("text");return n.textContent=h(r).toUpperCase(),t.append(e,n),t}function P(r,t,e){let n=Math.sqrt(3)/2*e.edge,o=l("g");o.classList.add("chord");let i=l("path"),s=l("text"),c=h(r),a=0;switch(t){case"major":a=-1,s.textContent=c.toUpperCase(),o.dataset.notes=[r,r+4,r+7].join(",");break;case"minor":a=1,s.textContent=c.toLowerCase(),o.dataset.notes=[r,r+3,r+7].join(",");break}return i.setAttribute("d",`M ${-e.edge/2} ${a*n/2} h ${e.edge} l ${-e.edge/2} ${-a*n} Z`),s.setAttribute("y",`${a*n/6}`),o.append(i,s),o}var N=class extends HTMLElement{outputs=[new T];svg=l("svg");activeNotes=new Map;get shadowRoot(){return super.shadowRoot}get layout(){return this.getAttribute("layout")}constructor(){super(),this.attachShadow({mode:"open"});let{shadowRoot:t}=this;t.addEventListener("pointerdown",this)}configure(t){let{svg:e,offsetWidth:n,offsetHeight:o}=this,i=[n,o];switch(this.setAttribute("layout",t.type),t.type){case"tonnetz":e.replaceChildren(j(i,t));break;case"circle":e.replaceChildren(z(i,t));break}}async connectedCallback(){let{shadowRoot:t,svg:e}=this,n=document.createElement("link");n.rel="stylesheet",n.href=import.meta.resolve("./midi-keyboard.css"),t.replaceChildren(n,e),await ne(n),this.configure({type:"tonnetz"})}handleEvent(t){let e=t.target.closest("[data-notes]");if(e)switch(t.type){case"pointerdown":let n=new AbortController,{signal:o}=n,i=()=>{n.abort(),this.processEvent(e,"off")};e.addEventListener("pointerup",i,{signal:o}),e.addEventListener("pointerleave",i,{signal:o}),this.processEvent(e,"on"),e.parentNode.append(e);break}}processEvent(t,e){let{outputs:n,activeNotes:o}=this,i=R(t),s=0,c=[];i.forEach(a=>{let d=o.get(a)||0;if(d+=e=="on"?1:-1,d==0){o.delete(a),c.push(a);let u=[128+s,a,100];n.forEach(m=>m.send(u))}else if(o.set(a,d),d==1){c.push(a);let u=[144+s,a,100];n.forEach(m=>m.send(u))}}),c.forEach(a=>this.syncActive(a))}onMidiMessage(t){let{activeNotes:e}=this,[n,o,i]=t;switch(n&240){case 144:i?e.set(o,1):e.delete(o);break;case 128:e.delete(o);break}this.syncActive(o)}syncActive(t){let{activeNotes:e,shadowRoot:n}=this;[...n.querySelectorAll(`[data-notes*="${t}"]`)].forEach(o=>{let s=R(o).every(c=>e.has(c));o.classList.toggle("active",s)})}};customElements.define("midi-keyboard",N);function ne(r){let{resolve:t,promise:e}=Promise.withResolvers();return r.addEventListener("load",t),e}function R(r){return r.dataset.notes.split(",").map(Number)}export{N as default};
