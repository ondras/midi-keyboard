var S=["A","B\u266D","B","C","C\u266F","D","D\u266F","E","F","F\u266F","G","G\u266F"];function k(r){return 440*2**((r-69)/12)}function h(r){return S[(r+3)%S.length]}var U=.05,F=.05,T=class extends EventTarget{id="synth";manufacturer="ondras";name="web audio synth";type="output";version="0.0.1";state="connected";connection="open";onstatechange=null;ctx=new AudioContext;playing=new Map;output;async open(){return this}async close(){return this}constructor(){super();let{ctx:n}=this,e=n.createDynamicsCompressor();e.connect(n.destination),this.output=e}send(n,e){let[t,o,i]=n;switch(t&240){case 144:i?this.noteOn(o):this.noteOff(o);break;case 128:this.noteOff(o);break}}noteOn(n){let{playing:e,ctx:t,output:o}=this;if(e.has(n))return;let i=V(t,k(n));i.gain.connect(o),e.set(n,i)}noteOff(n){let{playing:e}=this,t=e.get(n);t&&(q(t),e.delete(n))}};function V(r,n){let e=r.createOscillator(),t=r.createGain();return t.gain.setValueAtTime(0,r.currentTime),t.gain.linearRampToValueAtTime(1,r.currentTime+U),e.frequency.value=n,e.connect(t),e.start(),{oscillator:e,gain:t}}function q(r){let{oscillator:n,gain:e}=r,{currentTime:t}=e.context;e.gain.setValueAtTime(1,t),e.gain.linearRampToValueAtTime(0,t+F),n.stop(t+F)}function d(r){return document.createElementNS("http://www.w3.org/2000/svg",r)}var Z={center:60,edge:100,mainAxis:"horizontal",invert:!1},_=7;function D(r,n){let e={...Z,...n},t=e.invert?4:3,o=e.mainAxis=="vertical"?-1:1,i=document.createDocumentFragment(),l=d("g"),s=d("g");i.append(l,s);let[c,a]=r;e.mainAxis=="vertical"&&([c,a]=[a,c]);let u=Math.sqrt(3)/2*e.edge,p=Math.ceil(a/2/u),f=Math.ceil(c/2/e.edge);for(let m of j(p)){let O=Math.abs(m%2),L=e.center-m*t;L+=Math.ceil(m/2)*_;for(let N of j(f)){let b=L+N*_;if(b<21||b>127)continue;let M=c/2+o*e.edge*(N+O/2),w=a/2+m*u;[M,w]=[Math.round(M),Math.round(w)+.5];let $=W(b);s.append($);let C=[$];if(N<f){if(m>-p){let g=e.invert?"minor":"major",y=I(b,g,e);C.push(y),l.append(y)}if(m<p){let g=e.invert?"major":"minor",y=I(b,g,e);C.push(y),l.append(y)}}let G=B(M,w,e.mainAxis);C.forEach(g=>g.setAttribute("transform",G))}}return i}function B(r,n,e){switch(e){case"horizontal":return`translate(${r} ${n})`;case"vertical":return`translate(${n} ${r})`}}function W(r){let n=d("g");n.classList.add("note"),n.dataset.notes=[r].join(",");let e=d("circle"),t=d("text");return t.textContent=h(r),n.append(e,t),n}function I(r,n,e){let{edge:t}=e,o=Math.sqrt(3)/2*t,i=d("g");i.classList.add("chord");let l=d("path"),s=d("text"),c=h(r),a=e.invert?-1:1;switch(n){case"major":a*=1,s.textContent=c.toUpperCase(),i.dataset.notes=[r,r+4,r+7].join(",");break;case"minor":a*=-1,s.textContent=c.toLowerCase(),i.dataset.notes=[r,r+3,r+7].join(",");break}switch(e.mainAxis){case"horizontal":l.setAttribute("d",`M 0 0 h ${t} l ${-t/2} ${a*o} Z`),s.setAttribute("x",`${t/2}`),s.setAttribute("y",`${a*o/3}`);break;case"vertical":l.setAttribute("d",`M 0 0 v ${-t} l ${a*o} ${t/2} Z`),s.setAttribute("x",`${a*o/3}`),s.setAttribute("y",`${-t/2}`);break}return i.append(l,s),i}function*Y(r,n,e=1){for(let t=r;t<n;t+=e)yield t}function j(r){return Y(-r,r+1)}var P=12,Q={center:60,step:1,edge:60};function z(r,n){let e={...Q,...n},{edge:t}=e,o=document.createDocumentFragment(),l=Math.min(...r)/2*3/4;for(let s=0;s<P;s++){let c=s*Math.PI*2/P;c-=Math.PI/2;let a=r[0]/2+Math.cos(c)*l,u=r[1]/2+Math.sin(c)*l,p=e.center+s*e.step%12,f=ee(p);f.setAttribute("transform",`translate(${a}, ${u-t/2})`);let m=R(p,"major",e);m.setAttribute("transform",`translate(${a-t/3}, ${u+t/3})`);let O=R(p,"minor",e);O.setAttribute("transform",`translate(${a+t/3}, ${u+t/3})`),o.append(f,m,O)}return o}function ee(r){let n=d("g");n.classList.add("note"),n.dataset.notes=[r].join(",");let e=d("circle"),t=d("text");return t.textContent=h(r).toUpperCase(),n.append(e,t),n}function R(r,n,e){let{edge:t}=e,o=Math.sqrt(3)/2*t,i=d("g");i.classList.add("chord");let l=d("path"),s=d("text"),c=h(r),a=0;switch(n){case"major":a=-1,s.textContent=c.toUpperCase(),i.dataset.notes=[r,r+4,r+7].join(",");break;case"minor":a=1,s.textContent=c.toLowerCase(),i.dataset.notes=[r,r+3,r+7].join(",");break}return l.setAttribute("d",`M ${-t/2} ${a*o/2} h ${t} l ${-t/2} ${-a*o} Z`),s.setAttribute("y",`${a*o/6}`),i.append(l,s),i}var v=class extends HTMLElement{outputs=[new T];svg=d("svg");activeNotes=new Map;get shadowRoot(){return super.shadowRoot}get layout(){return this.getAttribute("layout")}constructor(){super(),this.attachShadow({mode:"open"});let{shadowRoot:n}=this;n.addEventListener("pointerdown",this)}configure(n){let{svg:e,offsetWidth:t,offsetHeight:o}=this,i=[t,o];switch(this.setAttribute("layout",n.type),n.type){case"tonnetz":e.replaceChildren(D(i,n));break;case"circle":e.replaceChildren(z(i,n));break}}async connectedCallback(){let{shadowRoot:n,svg:e}=this,t=document.createElement("link");t.rel="stylesheet",t.href=import.meta.resolve("./midi-keyboard.css"),n.replaceChildren(t,e),await ne(t),this.configure({type:"circle"})}handleEvent(n){let e=n.target.closest("[data-notes]");if(e)switch(n.type){case"pointerdown":let t=new AbortController,{signal:o}=t,i=()=>{t.abort(),this.processEvent(e,"off")};e.addEventListener("pointerup",i,{signal:o}),e.addEventListener("pointerleave",i,{signal:o}),this.processEvent(e,"on"),e.parentNode.append(e);break}}processEvent(n,e){let{outputs:t,activeNotes:o}=this,i=H(n),l=0,s=[];i.forEach(c=>{let a=o.get(c)||0;if(a+=e=="on"?1:-1,a==0){o.delete(c),s.push(c);let u=[128+l,c,100];t.forEach(p=>p.send(u))}else if(o.set(c,a),a==1){s.push(c);let u=[144+l,c,100];t.forEach(p=>p.send(u))}}),s.forEach(c=>this.syncActive(c))}onMidiMessage(n){let{activeNotes:e}=this,[t,o,i]=n;switch(t&240){case 144:i?e.set(o,1):e.delete(o);break;case 128:e.delete(o);break}this.syncActive(o)}syncActive(n){let{activeNotes:e,shadowRoot:t}=this;[...t.querySelectorAll(`[data-notes*="${n}"]`)].forEach(o=>{let l=H(o).every(s=>e.has(s));o.classList.toggle("active",l)})}};customElements.define("midi-keyboard",v);function ne(r){let{resolve:n,promise:e}=Promise.withResolvers();return r.addEventListener("load",n),e}function H(r){return r.dataset.notes.split(",").map(Number)}export{v as default};
