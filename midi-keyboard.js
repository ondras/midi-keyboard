var S=["A","B\u266D","B","C","C\u266F","D","D\u266F","E","F","F\u266F","G","G\u266F"];function k(o){return 440*2**((o-69)/12)}function O(o){return S[(o+3)%S.length]}var G=.05,_=.05,b=class extends EventTarget{id="synth";manufacturer="ondras";name="web audio synth";type="output";version="0.0.1";state="connected";connection="open";onstatechange=null;ctx=new AudioContext;playing=new Map;output;async open(){return this}async close(){return this}constructor(){super();let{ctx:t}=this,e=t.createDynamicsCompressor();e.connect(t.destination),this.output=e}send(t,e){let[n,r,a]=t;switch(n&240){case 144:a?this.noteOn(r):this.noteOff(r);break;case 128:this.noteOff(r);break}}noteOn(t){let{playing:e,ctx:n,output:r}=this;if(e.has(t))return;let a=D(n,k(t));a.gain.connect(r),e.set(t,a)}noteOff(t){let{playing:e}=this,n=e.get(t);n&&(V(n),e.delete(t))}};function D(o,t){let e=o.createOscillator(),n=o.createGain();return n.gain.setValueAtTime(0,o.currentTime),n.gain.linearRampToValueAtTime(1,o.currentTime+G),e.frequency.value=t,e.connect(n),e.start(),{oscillator:e,gain:n}}function V(o){let{oscillator:t,gain:e}=o,{currentTime:n}=e.context;e.gain.setValueAtTime(1,n),e.gain.linearRampToValueAtTime(0,n+_),t.stop(n+_)}var q={center:60,edge:100,mainAxis:"horizontal",invert:!1},F=7;function R(o,t){let e={...q,...t},n=e.invert?4:3,r=e.mainAxis=="vertical"?-1:1,a=d("svg"),s=d("g"),c=d("g");a.append(s,c);let[i,l]=o;e.mainAxis=="vertical"&&([i,l]=[l,i]);let m=Math.sqrt(3)/2*e.edge,u=Math.ceil(l/2/m),w=Math.ceil(i/2/e.edge);for(let p of I(u)){let z=Math.abs(p%2),C=e.center-p*n;C+=Math.ceil(p/2)*F;for(let E of I(w)){let h=C+E*F;if(h<21||h>127)continue;let A=i/2+r*e.edge*(E+z/2),N=l/2+p*m;[A,N]=[Math.round(A),Math.round(N)+.5];let x=U(A,N,e.mainAxis),L=X(h);if(L.setAttribute("transform",x),c.append(L),E<w){if(p>-u){let v=e.invert?"minor":"major",f=$(h,v,e);f.setAttribute("transform",x),s.append(f)}if(p<u){let v=e.invert?"major":"minor",f=$(h,v,e);f.setAttribute("transform",x),s.append(f)}}}}return a}function U(o,t,e){switch(e){case"horizontal":return`translate(${o} ${t})`;case"vertical":return`translate(${t} ${o})`}}function X(o){let t=d("g");t.classList.add("note"),t.dataset.notes=[o].join(",");let e=d("circle"),n=d("text");return n.textContent=O(o),t.append(e,n),t}function $(o,t,e){let n=Math.sqrt(3)/2*e.edge,r=d("g");r.classList.add("chord");let a=d("path"),s=d("text"),c=O(o),i=e.invert?-1:1;switch(t){case"major":i*=1,s.textContent=c.toUpperCase(),r.dataset.notes=[o,o+4,o+7].join(",");break;case"minor":i*=-1,s.textContent=c.toLowerCase(),r.dataset.notes=[o,o+3,o+7].join(",");break}switch(e.mainAxis){case"horizontal":a.setAttribute("d",`M 0 0 h ${e.edge} l ${-e.edge/2} ${i*n} Z`),s.setAttribute("x",`${e.edge/2}`),s.setAttribute("y",`${i*n/3}`);break;case"vertical":a.setAttribute("d",`M 0 0 v ${-e.edge} l ${i*n} ${e.edge/2} Z`),s.setAttribute("x",`${i*n/3}`),s.setAttribute("y",`${-e.edge/2}`);break}return r.append(a,s),r}function d(o){return document.createElementNS("http://www.w3.org/2000/svg",o)}function*K(o,t,e=1){for(let n=o;n<t;n+=e)yield n}function I(o){return K(-o,o+1)}var T=class extends HTMLElement{outputs=[new b];activeNotes=new Map;get shadowRoot(){return super.shadowRoot}get layout(){return this.getAttribute("layout")}constructor(){super(),this.attachShadow({mode:"open"});let{shadowRoot:t}=this;t.addEventListener("pointerdown",this)}async connectedCallback(){let{shadowRoot:t}=this,e=document.createElement("link");e.rel="stylesheet",e.href=import.meta.resolve("./midi-keyboard.css"),t.replaceChildren(e),await Z(e);let n=[this.offsetWidth,this.offsetHeight],r=R(n,{});this.setAttribute("layout","tonnetz"),t.append(r)}handleEvent(t){let e=t.target.closest("[data-notes]");if(e)switch(t.type){case"pointerdown":let n=new AbortController,{signal:r}=n,a=()=>{n.abort(),this.processEvent(e,"off")};e.addEventListener("pointerup",a,{signal:r}),e.addEventListener("pointerleave",a,{signal:r}),this.processEvent(e,"on"),e.parentNode.append(e);break}}processEvent(t,e){let{outputs:n,activeNotes:r}=this,a=H(t),s=0,c=[];a.forEach(i=>{let l=r.get(i)||0;if(l+=e=="on"?1:-1,l==0){r.delete(i),c.push(i);let m=[128+s,i,100];n.forEach(u=>u.send(m))}else if(r.set(i,l),l==1){c.push(i);let m=[144+s,i,100];n.forEach(u=>u.send(m))}}),c.forEach(i=>this.syncActive(i))}onMidiMessage(t){let{activeNotes:e}=this,[n,r,a]=t;switch(n&240){case 144:a?e.set(r,1):e.delete(r);break;case 128:e.delete(r);break}this.syncActive(r)}syncActive(t){let{activeNotes:e,shadowRoot:n}=this;[...n.querySelectorAll(`[data-notes*="${t}"]`)].forEach(r=>{let s=H(r).every(c=>e.has(c));r.classList.toggle("active",s)})}};customElements.define("midi-keyboard",T);function Z(o){let{resolve:t,promise:e}=Promise.withResolvers();return o.addEventListener("load",t),e}function H(o){return o.dataset.notes.split(",").map(Number)}export{T as default};
