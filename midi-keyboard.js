var z=["A","B\u266D","B","C","C\u266F","D","D\u266F","E","F","F\u266F","G","G\u266F"];function H(o){return 440*2**((o-69)/12)}function b(o){return z[(o+3)%z.length]}function O(o){return o%12*360/12}async function I(){return navigator.requestMIDIAccess()}var Q=.05,R=.05,E=class extends EventTarget{id="synth";manufacturer="ondras";name="web audio synth";type="output";version="0.0.1";state="connected";connection="open";onstatechange=null;ctx=new AudioContext;playing=new Map;output;async open(){return this}async close(){return this}constructor(){super();let{ctx:t}=this,e=t.createDynamicsCompressor();e.connect(t.destination),this.output=e}send(t,e){let[n,r,i]=t;switch(n&240){case 144:i?this.noteOn(r):this.noteOff(r);break;case 128:this.noteOff(r);break}}noteOn(t){let{playing:e,ctx:n,output:r}=this;if(e.has(t))return;let i=ee(n,H(t));i.gain.connect(r),e.set(t,i)}noteOff(t){let{playing:e}=this,n=e.get(t);n&&(te(n),e.delete(t))}};function ee(o,t){let e=o.createOscillator(),n=o.createGain();return n.gain.setValueAtTime(0,o.currentTime),n.gain.linearRampToValueAtTime(1,o.currentTime+Q),e.frequency.value=t,e.connect(n),e.start(),{oscillator:e,gain:n}}function te(o){let{oscillator:t,gain:e}=o,{currentTime:n}=e.context;e.gain.setValueAtTime(1,n),e.gain.linearRampToValueAtTime(0,n+R),t.stop(n+R)}function p(o){return document.createElementNS("http://www.w3.org/2000/svg",o)}var re={center:60,edge:100,mainAxis:"vertical",invert:!1,wrap:!1};function $(o){return{...re,...o}}var P=7;function q(o,t){let e=$(t);function n(u){return e.wrap?le(u,e.center):u}let r=e.invert?4:3,i=e.mainAxis=="vertical"?-1:1,s=document.createDocumentFragment(),l=p("g"),a=p("g");s.append(l,a);let[m,c]=o;e.mainAxis=="vertical"&&([m,c]=[c,m]);let d=Math.sqrt(3)/2*e.edge,h=Math.ceil(c/2/d),g=Math.ceil(m/2/e.edge);for(let u of j(h)){let Y=Math.abs(u%2),_=e.center-u*r;_+=Math.ceil(u/2)*P;for(let N of j(g)){let f=n(_+N*P);if(f<21||f>127)continue;let k=m/2+i*e.edge*(N+Y/2),L=c/2+u*d;[k,L]=[Math.round(k),Math.round(L)+.5];let C=ae(f);C.style.setProperty("--hue",String(O(f))),a.append(C);let S=[C];if(N<g){if(u>-h){let v=e.invert?"minor":"major",y=D(f,v,e,n);S.push(y),l.append(y)}if(u<h){let v=e.invert?"major":"minor",y=D(f,v,e,n);S.push(y),l.append(y)}}let J=ie(k,L,e.mainAxis);S.forEach(v=>v.setAttribute("transform",J))}}return s}function ie(o,t,e){switch(e){case"horizontal":return`translate(${o} ${t})`;case"vertical":return`translate(${t} ${o})`}}function ae(o){let t=p("g");t.classList.add("note"),t.dataset.notes=[o].join(",");let e=p("circle"),n=p("text");return n.textContent=b(o),t.append(e,n),t}function D(o,t,e,n){let{edge:r}=e,i=Math.sqrt(3)/2*r,s=p("g");s.classList.add("chord");let l=p("path"),a=p("text"),m=b(o),c=e.invert?-1:1;switch(t){case"major":c*=1,a.textContent=m.toUpperCase(),s.dataset.notes=[o,o+4,o+7].map(n).join(",");break;case"minor":c*=-1,a.textContent=m.toLowerCase(),s.dataset.notes=[o,o+3,o+7].map(n).join(",");break}switch(e.mainAxis){case"horizontal":l.setAttribute("d",`M 0 0 h ${r} l ${-r/2} ${c*i} Z`),a.setAttribute("x",`${r/2}`),a.setAttribute("y",`${c*i/3}`);break;case"vertical":l.setAttribute("d",`M 0 0 v ${-r} l ${c*i} ${r/2} Z`),a.setAttribute("x",`${c*i/3}`),a.setAttribute("y",`${-r/2}`);break}return s.append(l,a),s}function*se(o,t,e=1){for(let n=o;n<t;n+=e)yield n}function j(o){return se(-o,o+1)}function le(o,t){let e=(o-t)%12;return e<0&&(e+=12),t+e}var K=12,ce={center:60,step:1};function F(o){return{...ce,...o}}function U(o,t){let e=F(t);function n(a){return me(a,e.center)}let r=document.createDocumentFragment(),i=Math.min(...o),s=i/2*.78,l=i*.1;for(let a=0;a<K;a++){let m=a*Math.PI*2/K-Math.PI/2,c=o[0]/2+Math.cos(m)*s,d=o[1]/2+Math.sin(m)*s;c=Math.round(c)+.5,d=Math.round(d)+.5;let h=n(e.center+a*e.step),g=[pe(h,l),V(h,"major",l,n),V(h,"minor",l,n)];g.forEach(u=>u.setAttribute("transform",`translate(${c}, ${d})`)),r.append(...g)}return r}function pe(o,t){let e=p("g");e.classList.add("note"),e.dataset.notes=[o].join(","),e.style.setProperty("--hue",String(O(o)));let n=p("path");n.setAttribute("d",`M ${-t} 0 h ${2*t} a ${t} ${t} 0 1 0 ${-2*t} 0`);let r=p("text");return r.setAttribute("y",`${-t/2}`),r.textContent=b(o).toUpperCase(),e.append(n,r),e}function V(o,t,e,n){let r=p("g");r.classList.add("chord");let i=p("path"),s=p("text"),l=0,a=1;switch(t){case"major":l=-1,a=1,s.textContent="Maj",r.dataset.notes=[o,o+4,o+7].map(n).join(",");break;case"minor":l=1,a=0,s.textContent="Min",r.dataset.notes=[o,o+3,o+7].map(n).join(",");break}return i.setAttribute("d",`M 0 0 v ${e} a ${e} ${e} 0 0 ${a} ${e*l} ${-e} z`),s.setAttribute("x",`${e*l/2.5}`),s.setAttribute("y",`${e/2.5}`),r.append(i,s),r}function me(o,t){return t+(o-t)%12}var w=class extends HTMLElement{static get observedAttributes(){return["for"]}midiKeyboard;get shadowRoot(){return super.shadowRoot}getForm(t){return this.shadowRoot.querySelector(`form[name="${t}"]`)}get layout(){return this.shadowRoot.querySelector("[name=layout]")}constructor(){super(),this.attachShadow({mode:"open"}),this.hidden=!0}async attributeChangedCallback(t,e,n){switch(t){case"for":if(!n)return;let r=document.getElementById(n);if(!r)return;await customElements.whenDefined(r.localName);let i=r;this.midiKeyboard=i,this.loadConfig(i),i.addEventListener("change",s=>this.loadConfig(i));break}}connectedCallback(){let{shadowRoot:t}=this;t.innerHTML=ue;let e=document.createElement("link");e.rel="stylesheet",e.href=import.meta.resolve("./midi-keyboard-config.css"),t.append(e);let n=this.getForm("tonnetz");X(n.elements.root),B(n.elements.octave);let r=this.getForm("circle");X(r.elements.root),B(r.elements.octave),t.querySelector("[name=ear]").addEventListener("click",i=>this.hidden=!this.hidden),[n,r].forEach(i=>i.addEventListener("input",s=>{let{midiKeyboard:l}=this;if(!l)return;let a=this.getConfig();l.configure(a)})),this.layout.addEventListener("change",i=>{let{midiKeyboard:s,layout:l}=this;s&&s.configure({type:l.value})})}loadConfig(t){let{layout:e}=this,n=t.options;if(!n){e.value="";return}e.value=n.type;let r=this.getForm(n.type);switch(n.type){case"circle":{let i=F(n);r.elements.step.value=i.step,r.elements.root.value=i.center%12,r.elements.octave.value=Math.floor(i.center/12)-2}break;case"tonnetz":{let i=$(n);r.elements.wrap.checked=i.wrap,r.elements.invert.checked=i.invert,r.elements.direction.value=i.mainAxis,r.elements.root.value=i.center%12,r.elements.octave.value=Math.floor(i.center/12)-2}break}}getConfig(){let{layout:t}=this,e=t.value,n=this.getForm(e);switch(e){case"circle":return{type:e,step:Number(n.elements.step.value),center:12*(Number(n.elements.octave.value)+2)+Number(n.elements.root.value)};case"tonnetz":return{type:e,center:12*(Number(n.elements.octave.value)+2)+Number(n.elements.root.value),wrap:n.elements.wrap.checked,invert:n.elements.invert.checked,mainAxis:n.elements.direction.value,edge:n.elements.edge.valueAsNumber}}}},ue=`
<label>Layout:
	<select name="layout">
		<option value="tonnetz">Tonnetz</option>
		<option value="circle">Circle</option>
	</select>
</label>

<form name="tonnetz">
	<label>Root note: <select name="root"></select></label>
	<label>Octave: <select name="octave"></select></label>
	<label>Direction: <select name="direction">
		<option value="horizontal">Horizontal</option>
		<option value="vertical">Vertical</option>
	</select></label>
	<label>Invert: <input type="checkbox" name="invert" /></label>
	<label>Wrap: <input type="checkbox" name="wrap" /></label>
	<label>Edge length: <input type="range" name="edge" min="50" max="150" /></label>
</form>

<form name="circle">
	<label>Root note: <select name="root"></select></label>
	<label>Octave: <select name="octave"></select></label>
	<label>Step: <select name="step">
		<option value="1">1 semitone</option>
		<option value="5">5 semitones (4ths)</option>
		<option value="7">7 semitones (5ths)</option>
	</select></label>
</form>

<button name="ear">\u2699\uFE0F</button>
`;function X(o){for(let t=0;t<12;t++){let e=new Option(b(t),String(t));o.append(e)}}function B(o){for(let t=0;t<7;t++){let e=new Option(String(t));o.append(e)}}customElements.define("midi-keyboard-config",w);var M=class extends HTMLElement{outputs=[new E];svg=p("svg");_options;activeNotes=new Map;get shadowRoot(){return super.shadowRoot}get layout(){return this.getAttribute("layout")}get options(){return this._options}constructor(){super(),this.attachShadow({mode:"open"});let{shadowRoot:t,svg:e}=this;t.addEventListener("pointerdown",this),new ResizeObserver(()=>this.redraw()).observe(e),I().then(r=>{let i=[...r.outputs.values()];this.outputs.push(...i)})}redraw(){let{svg:t,offsetWidth:e,offsetHeight:n,options:r}=this;if(!r)return;let i=[e,n];switch(r.type){case"tonnetz":t.replaceChildren(q(i,r));break;case"circle":t.replaceChildren(U(i,r));break}}configure(t){this._options=t,this.setAttribute("layout",t.type),this.dispatchEvent(new Event("change")),this.redraw()}async connectedCallback(){let{shadowRoot:t,svg:e}=this,n=document.createElement("link");n.rel="stylesheet",n.href=import.meta.resolve("./midi-keyboard.css"),t.replaceChildren(n,e),await de(n),this.configure({type:"circle"})}handleEvent(t){let e=t.target.closest("[data-notes]");if(e)switch(t.type){case"pointerdown":let n=new AbortController,{signal:r}=n,i=()=>{n.abort(),this.processEvent(e,"off")};e.addEventListener("pointerup",i,{signal:r}),e.addEventListener("pointerleave",i,{signal:r}),this.processEvent(e,"on"),e.parentNode.append(e);break}}processEvent(t,e){let{outputs:n,activeNotes:r}=this,i=Z(t),s=0,l=[];i.forEach(a=>{let m=r.get(a)||0;if(m+=e=="on"?1:-1,m==0){r.delete(a),l.push(a);let c=[128+s,a,100];n.forEach(d=>d.send(c))}else if(r.set(a,m),m==1){l.push(a);let c=[144+s,a,100];n.forEach(d=>d.send(c))}}),l.forEach(a=>this.syncActive(a))}onMidiMessage(t){let{activeNotes:e}=this,[n,r,i]=t;switch(n&240){case 144:i?e.set(r,1):e.delete(r);break;case 128:e.delete(r);break}this.syncActive(r)}syncActive(t){let{activeNotes:e,shadowRoot:n}=this;[...n.querySelectorAll(`[data-notes*="${t}"]`)].forEach(r=>{let s=Z(r).every(l=>e.has(l));r.classList.toggle("active",s)})}};customElements.define("midi-keyboard",M);function de(o){let{resolve:t,promise:e}=Promise.withResolvers();return o.addEventListener("load",t),e}function Z(o){return o.dataset.notes.split(",").map(Number)}export{M as default};
