var w=["A","B\u266D","B","C","C\u266F","D","D\u266F","E","F","F\u266F","G","G\u266F"];function S(r){return 440*2**((r-69)/12)}function A(r){return w[(r+3)%w.length]}var k=.05,L=.05,b=class extends EventTarget{id="synth";manufacturer="ondras";name="web audio synth";type="output";version="0.0.1";state="connected";connection="open";onstatechange=null;ctx=new AudioContext;playing=new Map;output;async open(){return this}async close(){return this}constructor(){super();let{ctx:t}=this,e=t.createDynamicsCompressor();e.connect(t.destination),this.output=e}send(t,e){let[o,s,n]=t;switch(o&240){case 144:n?this.noteOn(s):this.noteOff(s);break;case 128:this.noteOff(s);break}}noteOn(t){let{playing:e,ctx:o,output:s}=this;if(e.has(t))return;let n=H(o,S(t));n.gain.connect(s),e.set(t,n)}noteOff(t){let{playing:e}=this,o=e.get(t);o&&(D(o),e.delete(t))}};function H(r,t){let e=r.createOscillator(),o=r.createGain();return o.gain.setValueAtTime(0,r.currentTime),o.gain.linearRampToValueAtTime(1,r.currentTime+k),e.frequency.value=t,e.connect(o),e.start(),{oscillator:e,gain:o}}function D(r){let{oscillator:t,gain:e}=r,{currentTime:o}=e.context;e.gain.setValueAtTime(1,o),e.gain.linearRampToValueAtTime(0,o+L),t.stop(o+L)}var V={center:60,edge:100,mainStep:7,topRightStep:3};function F(r,t){let e=c("svg"),o=c("g"),s=c("g");e.append(o,s);let n={...V,...t},[m,u]=r,i=Math.sqrt(3)/2*n.edge,p=Math.ceil(u/2/i),h=Math.ceil(m/2/n.edge);for(let d of C(p)){let _=Math.abs(d%2),v=n.center-d*n.topRightStep;v+=Math.ceil(d/2)*n.mainStep;for(let T of C(h)){let l=v+T*n.mainStep;if(l<21||l>127)continue;let f=m/2+T*n.edge+_*n.edge/2,g=u/2+d*i;[f,g]=[Math.round(f),Math.round(g)+.5];let O=P(A(l));if(O.node.setAttribute("transform",`translate(${f} ${g})`),O.dataset.notes=[l].join(","),s.append(O.node),T<h){let M=A(l);if(d>-p){let a=$(M.toLowerCase());a.node.setAttribute("transform",`translate(${f} ${g})`),a.dataset.notes=[l,l+n.topRightStep,l+n.mainStep].join(","),a.path.setAttribute("d",`M 0 0 l ${n.edge/2} ${-i} l ${n.edge/2} ${i} Z`),a.text.setAttribute("x",`${n.edge/2}`),a.text.setAttribute("y",`${-i/3}`),o.append(a.node)}if(d<p){let a=$(M.toUpperCase());a.node.setAttribute("transform",`translate(${f} ${g})`),a.dataset.notes=[l,l+n.mainStep-n.topRightStep,l+n.mainStep].join(","),a.path.setAttribute("d",`M 0 0 l ${n.edge/2} ${i} l ${n.edge/2} ${-i} Z`),a.text.setAttribute("x",`${n.edge/2}`),a.text.setAttribute("y",`${i/3}`),o.append(a.node)}}}}return e}function P(r){let t=c("g");t.classList.add("note");let e=c("circle"),o=c("text");return o.textContent=r,t.append(e,o),{node:t,dataset:t.dataset,text:o}}function $(r){let t=c("g");t.classList.add("chord");let e=c("path"),o=c("text");return o.textContent=r,t.append(e,o),{node:t,dataset:t.dataset,path:e,text:o}}function c(r){return document.createElementNS("http://www.w3.org/2000/svg",r)}function*z(r,t,e=1){for(let o=r;o<t;o+=e)yield o}function C(r){return z(-r,r+1)}var y=class extends HTMLElement{outputs=[new b];activeNotes=new Map;get shadowRoot(){return super.shadowRoot}get layout(){return this.getAttribute("layout")}constructor(){super(),this.attachShadow({mode:"open"});let{shadowRoot:t}=this;t.addEventListener("pointerdown",this)}async connectedCallback(){let{shadowRoot:t}=this,e=document.createElement("link");e.rel="stylesheet",e.href=import.meta.resolve("./midi-keyboard.css"),t.replaceChildren(e),await U(e);let o=[this.offsetWidth,this.offsetHeight],s=F(o,{});this.setAttribute("layout","tonnetz"),t.append(s)}handleEvent(t){let e=t.target.closest("[data-notes]");if(e)switch(t.type){case"pointerdown":let o=new AbortController,{signal:s}=o,n=()=>{o.abort(),this.processEvent(e,"off")};e.addEventListener("pointerup",n,{signal:s}),e.addEventListener("pointerleave",n,{signal:s}),this.processEvent(e,"on"),e.parentNode.append(e);break}}processEvent(t,e){let{outputs:o,activeNotes:s}=this,n=R(t),m=0,u=[];n.forEach(i=>{let p=s.get(i)||0;if(p+=e=="on"?1:-1,p==0){s.delete(i),u.push(i);let h=[128+m,i,100];o.forEach(d=>d.send(h))}else if(s.set(i,p),p==1){u.push(i);let h=[144+m,i,100];o.forEach(d=>d.send(h))}}),u.forEach(i=>this.syncActive(i))}onMidiMessage(t){let{activeNotes:e}=this,[o,s,n]=t;switch(o&240){case 144:n?e.set(s,1):e.delete(s);break;case 128:e.delete(s);break}this.syncActive(s)}syncActive(t){let{activeNotes:e,shadowRoot:o}=this;[...o.querySelectorAll(`[data-notes*="${t}"]`)].forEach(s=>{let m=R(s).every(u=>e.has(u));s.classList.toggle("active",m)})}};customElements.define("midi-keyboard",y);function U(r){let{resolve:t,promise:e}=Promise.withResolvers();return r.addEventListener("load",t),e}function R(r){return r.dataset.notes.split(",").map(Number)}export{y as default};
