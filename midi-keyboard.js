var S=["A","B\u266D","B","C","C\u266F","D","D\u266F","E","F","F\u266F","G","G\u266F"];function L(a){return 440*2**((a-69)/12)}function v(a){return S[(a+3)%S.length]}var y=class extends EventTarget{id="synth";manufacturer="ondras";name="web audio synth";type="output";version="0.0.1";state="connected";connection="open";onstatechange=null;ctx=new AudioContext;playing=new Map;async open(){return this}async close(){return this}send(t,e){let[s,o,n]=t;switch(s&240){case 144:n?this.noteOn(o):this.noteOff(o);break;case 128:this.noteOff(o);break}}noteOn(t){let{playing:e,ctx:s}=this;if(e.has(t))return;let o=s.createOscillator();o.frequency.value=L(t),o.connect(s.destination),o.start(),e.set(t,o)}noteOff(t){let{playing:e}=this,s=e.get(t);s&&(s.stop(),e.delete(t))}};var D={center:60,edge:100,mainStep:7,topRightStep:3};function F(a,t){let e=p("svg"),s=p("g"),o=p("g");e.append(s,o);let n={...D,...t},[m,u]=a,r=Math.sqrt(3)/2*n.edge,c=Math.ceil(u/2/r),h=Math.ceil(m/2/n.edge);for(let l=-c;l<=c;l++){let C=Math.abs(l%2),M=n.center-l*n.topRightStep;M+=Math.ceil(l/2)*n.mainStep;for(let f=-h;f<=h;f++){let d=M+f*n.mainStep;if(d<21||d>127)continue;let g=m/2+f*n.edge+C*n.edge/2,b=u/2+l*r;[g,b]=[Math.round(g),Math.round(b)+.5];let E=p("g");E.classList.add("note"),E.setAttribute("transform",`translate(${g} ${b})`),E.dataset.notes=[d].join(",");let k=p("circle"),w=p("text");if(w.textContent=v(d),E.append(k,w),o.append(E),f<h){let A=v(d);if(l>-c){let i=$(A.toLowerCase());i.node.setAttribute("transform",`translate(${g} ${b})`),i.dataset.notes=[d,d+n.topRightStep,d+n.mainStep].join(","),i.path.setAttribute("d",`M 0 0 l ${n.edge/2} ${-r} l ${n.edge/2} ${r} Z`),i.text.setAttribute("x",`${n.edge/2}`),i.text.setAttribute("y",`${-r/3}`),s.append(i.node)}if(l<c){let i=$(A.toUpperCase());i.node.setAttribute("transform",`translate(${g} ${b})`),i.dataset.notes=[d,d+n.mainStep-n.topRightStep,d+n.mainStep].join(","),i.path.setAttribute("d",`M 0 0 l ${n.edge/2} ${r} l ${n.edge/2} ${-r} Z`),i.text.setAttribute("x",`${n.edge/2}`),i.text.setAttribute("y",`${r/3}`),s.append(i.node)}}}}return e}function $(a){let t=p("g");t.classList.add("chord");let e=p("path"),s=p("text");return s.textContent=a,t.append(e,s),{node:t,dataset:t.dataset,path:e,text:s}}function p(a){return document.createElementNS("http://www.w3.org/2000/svg",a)}var x=class extends HTMLElement{outputs=[new y];activeNotes=new Map;get shadowRoot(){return super.shadowRoot}get layout(){return this.getAttribute("layout")}constructor(){super(),this.attachShadow({mode:"open"});let{shadowRoot:t}=this;t.addEventListener("pointerdown",this)}async connectedCallback(){let{shadowRoot:t}=this,e=document.createElement("link");e.rel="stylesheet",e.href=import.meta.resolve("./midi-keyboard.css"),t.replaceChildren(e),await I(e);let s=[this.offsetWidth,this.offsetHeight],o=F(s,{});this.setAttribute("layout","tonnetz"),t.append(o)}handleEvent(t){let e=t.target.closest("[data-notes]");if(e)switch(t.type){case"pointerdown":let s=new AbortController,{signal:o}=s,n=()=>{s.abort(),this.processEvent(e,"off")};e.addEventListener("pointerup",n,{signal:o}),e.addEventListener("pointerleave",n,{signal:o}),this.processEvent(e,"on");break}}processEvent(t,e){let{outputs:s,activeNotes:o}=this,n=_(t),m=0,u=[];n.forEach(r=>{let c=o.get(r)||0;if(c+=e=="on"?1:-1,c==0){o.delete(r),u.push(r);let h=[128+m,r,100];s.forEach(l=>l.send(h))}else if(o.set(r,c),c==1){u.push(r);let h=[144+m,r,100];s.forEach(l=>l.send(h))}}),u.forEach(r=>this.syncActive(r))}onMidiMessage(t){let{activeNotes:e}=this,[s,o,n]=t;switch(s&240){case 144:n?e.set(o,1):e.delete(o);break;case 128:e.delete(o);break}this.syncActive(o)}syncActive(t){let{activeNotes:e,shadowRoot:s}=this;[...s.querySelectorAll(`[data-notes*="${t}"]`)].forEach(o=>{let m=_(o).every(u=>e.has(u));o.classList.toggle("active",m)})}};customElements.define("midi-keyboard",x);function I(a){let{resolve:t,promise:e}=Promise.withResolvers();return a.addEventListener("load",t),e}function _(a){return a.dataset.notes.split(",").map(Number)}export{x as default};
